<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web3 Todo App</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ethers.js untuk fitur Web3 -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <style>
        .completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
        /* Animasi untuk task baru dan hapus */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .task-item {
            animation: fadeIn 0.3s ease-out;
        }
        /* Transisi untuk dark mode */
        body, .task-item {
            transition: background-color 0.3s, color 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header dengan toggle bahasa dan dark mode -->
        <header class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400">Web3 Todo App</h1>
            <div class="flex space-x-2">
                <!-- Toggle Bahasa -->
                <button id="languageToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600" aria-label="Toggle language">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                    </svg>
                </button>
                <!-- Toggle Dark Mode -->
                <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600" aria-label="Toggle dark mode">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden dark:block" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 dark:hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- Input Form -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
            <form id="todoForm" class="flex">
                <input 
                    type="text" 
                    id="taskInput" 
                    placeholder="" 
                    class="flex-1 border border-gray-300 dark:border-gray-600 rounded-l-lg py-2 px-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200"
                    aria-label="Input tugas baru"
                    required
                >
                <button 
                    type="submit" 
                    class="bg-indigo-600 text-white py-2 px-4 rounded-r-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                    aria-label="Tambah tugas"
                >
                    <span id="addButtonText">Tambah</span>
                </button>
            </form>
        </div>

        <!-- Wallet Connection Section -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-4 mb-6">
            <div class="flex flex-col space-y-3">
                <button 
                    id="connectWalletBtn" 
                    class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    aria-label="Hubungkan dompet Web3"
                >
                    <span id="connectWalletText">Connect Wallet</span>
                </button>
                <div id="walletInfo" class="hidden text-sm text-gray-600 dark:text-gray-400">
                    <p id="connectedText">Terhubung: <span id="walletAddress" class="font-mono"></span></p>
                </div>
                <button 
                    id="syncToWalletBtn" 
                    class="bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 hidden"
                    aria-label="Sinkronkan tugas ke dompet"
                >
                    <span id="syncButtonText">Sync to Wallet</span>
                </button>
                <div id="syncStatus" class="hidden text-sm"></div>
                <div id="walletError" class="hidden text-sm text-red-600 dark:text-red-400 mt-2 p-2 bg-red-50 dark:bg-red-900/20 rounded"></div>
            </div>
        </div>

        <!-- Task List -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
            <ul id="taskList" class="divide-y divide-gray-200 dark:divide-gray-700">
                <!-- Tasks will be added here dynamically -->
            </ul>
            <div id="emptyState" class="py-8 text-center text-gray-500 dark:text-gray-400">
                <p id="emptyStateText">Belum ada tugas. Tambahkan tugas baru!</p>
            </div>
        </div>
    </div>

    <script>
        // Inisialisasi state aplikasi
        let tasks = JSON.parse(localStorage.getItem('web3TodoTasks')) || [];
        let walletConnected = false;
        let provider, signer;
        let isIndonesian = true; // Default bahasa Indonesia
        let isDarkMode = localStorage.getItem('darkMode') === 'true' || 
                        (window.matchMedia('(prefers-color-scheme: dark)').matches && localStorage.getItem('darkMode') !== 'false');

        // Terjemahan untuk dua bahasa
        const translations = {
            id: {
                addButton: "Tambah",
                taskPlaceholder: "Tulis tugas baru...",
                emptyState: "Belum ada tugas. Tambahkan tugas baru!",
                connectWallet: "Connect Wallet",
                connected: "Terhubung:",
                syncButton: "Sync to Wallet",
                delete: "Hapus",
                complete: "Tandai selesai",
                incomplete: "Tandai belum selesai",
                preparingSync: "Mempersiapkan data untuk disinkronkan...",
                signMessage: "Silakan tanda tangani pesan di wallet Anda...",
                syncSuccess: "Berhasil disinkronkan!",
                noWallet: "MetaMask tidak terdeteksi. Pastikan MetaMask sudah diinstall dan diaktifkan untuk browser ini.",
                noWalletAlt: "MetaMask terdeteksi tetapi belum diaktifkan. Silakan buka ekstensi MetaMask dan aktifkan untuk website ini.",
                connectFirst: "Harap hubungkan wallet terlebih dahulu.",
                disconnected: "Wallet terputus.",
                refreshPage: "Refresh halaman setelah menginstall MetaMask."
            },
            en: {
                addButton: "Add",
                taskPlaceholder: "Write a new task...",
                emptyState: "No tasks yet. Add a new task!",
                connectWallet: "Connect Wallet",
                connected: "Connected:",
                syncButton: "Sync to Wallet",
                delete: "Delete",
                complete: "Mark as complete",
                incomplete: "Mark as incomplete",
                preparingSync: "Preparing data for sync...",
                signMessage: "Please sign the message in your wallet...",
                syncSuccess: "Successfully synced!",
                noWallet: "MetaMask not detected. Make sure MetaMask is installed and enabled for this browser.",
                noWalletAlt: "MetaMask detected but not enabled. Please open the MetaMask extension and enable it for this website.",
                connectFirst: "Please connect your wallet first.",
                disconnected: "Wallet disconnected.",
                refreshPage: "Refresh the page after installing MetaMask."
            }
        };

        // Elemen DOM
        const todoForm = document.getElementById('todoForm');
        const taskInput = document.getElementById('taskInput');
        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddress = document.getElementById('walletAddress');
        const syncToWalletBtn = document.getElementById('syncToWalletBtn');
        const syncStatus = document.getElementById('syncStatus');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const languageToggle = document.getElementById('languageToggle');
        const walletError = document.getElementById('walletError');

        // Fungsi untuk mendeteksi MetaMask
        function detectMetaMask() {
            // Cek jika ethereum terdefinisi
            if (typeof window.ethereum !== 'undefined') {
                // Cek jika ini adalah MetaMask
                if (window.ethereum.isMetaMask) {
                    return true;
                } else {
                    // Ethereum provider ada tapi bukan MetaMask
                    showWalletError(isIndonesian ? 
                        "Provider Ethereum terdeteksi, tetapi bukan MetaMask. Pastikan MetaMask diaktifkan." : 
                        "Ethereum provider detected, but it's not MetaMask. Make sure MetaMask is enabled.");
                    return false;
                }
            } else {
                // Cek cara alternatif untuk mendeteksi MetaMask
                if (typeof window.web3 !== 'undefined') {
                    return true;
                } else {
                    return false;
                }
            }
        }

        // Fungsi untuk menampilkan error wallet
        function showWalletError(message) {
            walletError.textContent = message;
            walletError.classList.remove('hidden');
            
            // Sembunyikan error setelah 5 detik
            setTimeout(() => {
                walletError.classList.add('hidden');
            }, 5000);
        }

        // Fungsi untuk menerapkan bahasa
        function applyLanguage() {
            const lang = isIndonesian ? 'id' : 'en';
            document.getElementById('addButtonText').textContent = translations[lang].addButton;
            document.getElementById('connectWalletText').textContent = translations[lang].connectWallet;
            document.getElementById('syncButtonText').textContent = translations[lang].syncButton;
            document.getElementById('emptyStateText').textContent = translations[lang].emptyState;
            document.getElementById('connectedText').textContent = translations[lang].connected;
            taskInput.placeholder = translations[lang].taskPlaceholder;
            
            // Update teks untuk task yang sudah ada
            document.querySelectorAll('.task-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                const deleteBtn = item.querySelector('button');
                const taskId = parseInt(checkbox.dataset.id);
                const task = tasks.find(t => t.id === taskId);
                
                if (task) {
                    checkbox.setAttribute('aria-label', task.completed ? translations[lang].incomplete : translations[lang].complete);
                    deleteBtn.setAttribute('aria-label', translations[lang].delete);
                }
            });
        }

        // Fungsi untuk menerapkan dark mode
        function applyDarkMode() {
            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                localStorage.setItem('darkMode', 'true');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('darkMode', 'false');
            }
        }

        // Fungsi untuk menyimpan tasks ke localStorage
        function saveTasks() {
            localStorage.setItem('web3TodoTasks', JSON.stringify(tasks));
        }

        // Fungsi untuk merender tasks
        function renderTasks() {
            taskList.innerHTML = '';
            
            if (tasks.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // Urutkan dari terbaru ke terlama (berdasarkan timestamp)
            const sortedTasks = [...tasks].sort((a, b) => b.timestamp - a.timestamp);
            
            sortedTasks.forEach(task => {
                const li = document.createElement('li');
                li.className = 'task-item p-4 flex items-center';
                
                const lang = isIndonesian ? 'id' : 'en';
                
                li.innerHTML = `
                    <input 
                        type="checkbox" 
                        ${task.completed ? 'checked' : ''} 
                        data-id="${task.id}"
                        class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500"
                        aria-label="${task.completed ? translations[lang].incomplete : translations[lang].complete}"
                    >
                    <span class="ml-3 flex-1 ${task.completed ? 'completed' : ''}">${task.text}</span>
                    <button 
                        data-id="${task.id}"
                        class="ml-2 text-red-600 hover:text-red-800 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 rounded-full p-1"
                        aria-label="${translations[lang].delete}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                
                taskList.appendChild(li);
            });
            
            // Tambahkan event listeners untuk checkbox dan tombol hapus
            document.querySelectorAll('input[type="checkbox"][data-id]').forEach(checkbox => {
                checkbox.addEventListener('change', toggleTask);
            });
            
            document.querySelectorAll('button[data-id]').forEach(button => {
                button.addEventListener('click', deleteTask);
            });
        }

        // Fungsi untuk menambah task baru
        function addTask(e) {
            e.preventDefault();
            
            const taskText = taskInput.value.trim();
            if (!taskText) return;
            
            const newTask = {
                id: Date.now(),
                text: taskText,
                completed: false,
                timestamp: Date.now()
            };
            
            tasks.push(newTask);
            saveTasks();
            renderTasks();
            
            // Reset form
            taskInput.value = '';
            taskInput.focus();
        }

        // Fungsi untuk menandai task selesai/belum
        function toggleTask(e) {
            const taskId = parseInt(e.target.dataset.id);
            const task = tasks.find(task => task.id === taskId);
            
            if (task) {
                task.completed = e.target.checked;
                saveTasks();
                
                // Update aria-label
                const lang = isIndonesian ? 'id' : 'en';
                e.target.setAttribute('aria-label', task.completed ? translations[lang].incomplete : translations[lang].complete);
            }
        }

        // Fungsi untuk menghapus task
        function deleteTask(e) {
            const taskId = parseInt(e.currentTarget.dataset.id);
            tasks = tasks.filter(task => task.id !== taskId);
            saveTasks();
            renderTasks();
        }

        // Fungsi untuk menghubungkan wallet
        async function connectWallet() {
            try {
                walletError.classList.add('hidden');
                
                // Cek jika MetaMask terdeteksi
                if (!detectMetaMask()) {
                    showWalletError(isIndonesian ? translations.id.noWallet + " " + translations.id.refreshPage : translations.en.noWallet + " " + translations.en.refreshPage);
                    return;
                }
                
                // Request koneksi akun
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                
                // Inisialisasi provider dan signer dari ethers.js
                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                const address = await signer.getAddress();
                
                // Tampilkan info wallet
                const shortAddress = `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
                walletAddress.textContent = shortAddress;
                walletInfo.classList.remove('hidden');
                syncToWalletBtn.classList.remove('hidden');
                
                walletConnected = true;
                connectWalletBtn.textContent = isIndonesian ? 'Disconnect' : 'Disconnect';
                
                // Update status sinkronisasi
                syncStatus.textContent = isIndonesian ? 'Wallet terhubung. Anda dapat menyinkronkan tugas.' : 'Wallet connected. You can sync your tasks.';
                syncStatus.className = 'text-sm text-green-600 dark:text-green-400';
                syncStatus.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                
                if (error.code === 4001) {
                    // User rejected the connection request
                    showWalletError(isIndonesian ? 
                        "Koneksi ditolak. Silakan setujui koneksi untuk melanjutkan." : 
                        "Connection rejected. Please approve the connection to continue.");
                } else {
                    showWalletError((isIndonesian ? 'Error menghubungkan wallet: ' : 'Error connecting wallet: ') + error.message);
                }
            }
        }

        // Fungsi untuk memutuskan wallet
        function disconnectWallet() {
            walletConnected = false;
            provider = null;
            signer = null;
            
            walletInfo.classList.add('hidden');
            syncToWalletBtn.classList.add('hidden');
            connectWalletBtn.textContent = isIndonesian ? translations.id.connectWallet : translations.en.connectWallet;
            
            syncStatus.textContent = isIndonesian ? translations.id.disconnected : translations.en.disconnected;
            syncStatus.className = 'text-sm text-gray-600 dark:text-gray-400';
        }

        // Fungsi untuk menyinkronkan ke wallet (hanya tanda tangan, tidak ada on-chain tx)
        async function syncToWallet() {
            if (!walletConnected) {
                syncStatus.textContent = isIndonesian ? translations.id.connectFirst : translations.en.connectFirst;
                syncStatus.className = 'text-sm text-red-600 dark:text-red-400';
                syncStatus.classList.remove('hidden');
                return;
            }
            
            try {
                const lang = isIndonesian ? 'id' : 'en';
                syncStatus.textContent = translations[lang].preparingSync;
                syncStatus.className = 'text-sm text-blue-600 dark:text-blue-400';
                
                // Buat snapshot data tugas
                const snapshot = {
                    app: "Web3 Todo App",
                    timestamp: Date.now(),
                    tasks: tasks
                };
                
                // Konversi ke string JSON
                const message = JSON.stringify(snapshot);
                
                // Minta tanda tangan dari pengguna
                syncStatus.textContent = translations[lang].signMessage;
                
                const signature = await signer.signMessage(message);
                
                // Tampilkan status berhasil
                syncStatus.textContent = translations[lang].syncSuccess + ' (Tanda tangan: ' + signature.substring(0, 10) + '...)';
                syncStatus.className = 'text-sm text-green-600 dark:text-green-400';
                
            } catch (error) {
                console.error('Error syncing to wallet:', error);
                syncStatus.textContent = (isIndonesian ? 'Error menyinkronkan: ' : 'Error syncing: ') + error.message;
                syncStatus.className = 'text-sm text-red-600 dark:text-red-400';
            }
        }

        // Event Listeners
        todoForm.addEventListener('submit', addTask);
        
        // Support menekan Enter untuk menambah task
        taskInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                todoForm.dispatchEvent(new Event('submit'));
            }
        });
        
        connectWalletBtn.addEventListener('click', function() {
            if (walletConnected) {
                disconnectWallet();
            } else {
                connectWallet();
            }
        });
        
        syncToWalletBtn.addEventListener('click', syncToWallet);
        
        // Toggle dark mode
        darkModeToggle.addEventListener('click', function() {
            isDarkMode = !isDarkMode;
            applyDarkMode();
        });
        
        // Toggle bahasa
        languageToggle.addEventListener('click', function() {
            isIndonesian = !isIndonesian;
            applyLanguage();
        });

        // Inisialisasi aplikasi
        document.addEventListener('DOMContentLoaded', function() {
            // Terapkan dark mode dan bahasa
            applyDarkMode();
            applyLanguage();
            renderTasks();
            
            // Cek jika MetaMask sudah terhubung sebelumnya
            if (detectMetaMask()) {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            connectWallet();
                        }
                    })
                    .catch(console.error);
                    
                // Listen untuk perubahan akun
                window.ethereum.on('accountsChanged', function(accounts) {
                    if (accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        connectWallet();
                    }
                });
                
                // Listen untuk chain changes
                window.ethereum.on('chainChanged', function(chainId) {
                    // Handle chain changes
                    console.log('Chain changed:', chainId);
                    window.location.reload();
                });
            }
        });

        // Catatan untuk migrasi ke on-chain:
        // 1. Gunakan smart contract untuk menyimpan tasks (biasanya dengan biaya gas)
        // 2. Implementasi event listening untuk update real-time
        // 3. Pertimbangkan arsitektur hybrid (localStorage + blockchain) untuk pengalaman pengguna yang lebih baik
    </script>
</body>
</html>